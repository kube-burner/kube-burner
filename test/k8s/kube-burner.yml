---

global:
  gc: {{env "GC"}}
  functionTemplates:
    - objectTemplates/envs.tpl
  measurements:
  - name: podLatency
{{ if .TIMESERIES_INDEXER }}
    timeseriesIndexer: {{env "TIMESERIES_INDEXER"}}
{{ end }}
  - name: nodeLatency
{{ if .TIMESERIES_INDEXER }}
    timeseriesIndexer: {{env "TIMESERIES_INDEXER"}}
{{ end }}
{{ if .SVC_LATENCY }}
  - name: serviceLatency
    svcTimeout: 5s
{{ end }}
  - name: jobLatency
metricsEndpoints:
{{ if .ES_INDEXING }}
  - endpoint: https://prometheus-k8s-openshift-monitoring.apps.quay-pp-ii.perfscale.devcluster.openshift.com
    token: eyJhbGciOiJSUzI1NiIsImtpZCI6IkxLVngybmxhMWtKU0VlT2pOTkl6ZXdOS0doV3lmVHNEWWNCZV9CRExDMTAifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTc3MTMwMDMxNCwiaWF0IjoxNzcxMjc4NzE0LCJpc3MiOiJodHRwczovL2t1YmVybmV0ZXMuZGVmYXVsdC5zdmMiLCJqdGkiOiIzNzQ1M2JkNC0wMTIzLTRiNGMtYWRlYi02NTc0YWI3NGI5ZTAiLCJrdWJlcm5ldGVzLmlvIjp7Im5hbWVzcGFjZSI6Im9wZW5zaGlmdC1tb25pdG9yaW5nIiwic2VydmljZWFjY291bnQiOnsibmFtZSI6InByb21ldGhldXMtazhzIiwidWlkIjoiNTI2ODhlYzYtYjNhMC00MWRhLWFmOGUtMmY4ZDIzYmZjNmUzIn19LCJuYmYiOjE3NzEyNzg3MTQsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpvcGVuc2hpZnQtbW9uaXRvcmluZzpwcm9tZXRoZXVzLWs4cyJ9.pR7Cviq8-kON7huzXM297JVW_z90RgBCfacMZYue-GcIRhZuL7ozp3Lv6qGUjsAiwf8-RtQ02Gy40wy1U8Wmbw4kRQfYiRBLejwcdFJRFlEynmLcb9CqjThFV_vLVbZt7i7ily7YIBhBpXJ0K1FMK7Q9ZrkYKgWmTLGetbAEQlTd7d2MH8wt2mnVbxnOb0c8zWP9w2L8F5XpRSXsiLpJlZxJ-2uGhu_gKun6XOO4mQfgQ_7KO1iivw6GXKN-kstzLiSkEiCyFQk5c67lStHVGZ5-2uWTe7cAbl7xJmC4v1PHJYqyRCtbr8e_at6w4fQ5cHyFfwyd9fMSdgA9cDEitgXhPcTr0WGBHkaoG2P7qJHdLO24WTuonb_2dLEMOTSAAnkYT32iaiid6i6PSWuF5L5Fsk4-nlLm7Rw30NhHfRsT5FxAdEnDbSlZWOIOlqrDT5o9Ke_W6I9OOEM1FkfaZPZDx4W9WrsTcuvfz8RRKKDke04x5Y1pBsTYbYYhiJxLdyLm5xiKwLOyP_YIWU7JofHCJFaEyAUsIeCl1OR1nmn8BnF-amLPvXefO95Vk_IgHrimxpQqr2D4Q5UdT78tGs4o1ewKKY4Rdn__x8_Tb95R-G57wkNqFWudSvbOCzOfRuk9o7aqjdKI3QQV2YZwB_3ylMKORtYFwqLOeQu6aBM
    indexer:
      type: opensearch
      esServers: ["{{ .ES_SERVER }}"]
      defaultIndex: {{ .ES_INDEX }}
    metrics: [metrics-profile.yaml]
{{ if .ALERTING }}
    alerts: [alerts.yml]
{{ end }}
{{ end }}
{{ if .LOCAL_INDEXING }}
  - endpoint: https://prometheus-k8s-openshift-monitoring.apps.quay-pp-ii.perfscale.devcluster.openshift.com
    token: eyJhbGciOiJSUzI1NiIsImtpZCI6IkxLVngybmxhMWtKU0VlT2pOTkl6ZXdOS0doV3lmVHNEWWNCZV9CRExDMTAifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTc3MTMwMDMxNCwiaWF0IjoxNzcxMjc4NzE0LCJpc3MiOiJodHRwczovL2t1YmVybmV0ZXMuZGVmYXVsdC5zdmMiLCJqdGkiOiIzNzQ1M2JkNC0wMTIzLTRiNGMtYWRlYi02NTc0YWI3NGI5ZTAiLCJrdWJlcm5ldGVzLmlvIjp7Im5hbWVzcGFjZSI6Im9wZW5zaGlmdC1tb25pdG9yaW5nIiwic2VydmljZWFjY291bnQiOnsibmFtZSI6InByb21ldGhldXMtazhzIiwidWlkIjoiNTI2ODhlYzYtYjNhMC00MWRhLWFmOGUtMmY4ZDIzYmZjNmUzIn19LCJuYmYiOjE3NzEyNzg3MTQsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpvcGVuc2hpZnQtbW9uaXRvcmluZzpwcm9tZXRoZXVzLWs4cyJ9.pR7Cviq8-kON7huzXM297JVW_z90RgBCfacMZYue-GcIRhZuL7ozp3Lv6qGUjsAiwf8-RtQ02Gy40wy1U8Wmbw4kRQfYiRBLejwcdFJRFlEynmLcb9CqjThFV_vLVbZt7i7ily7YIBhBpXJ0K1FMK7Q9ZrkYKgWmTLGetbAEQlTd7d2MH8wt2mnVbxnOb0c8zWP9w2L8F5XpRSXsiLpJlZxJ-2uGhu_gKun6XOO4mQfgQ_7KO1iivw6GXKN-kstzLiSkEiCyFQk5c67lStHVGZ5-2uWTe7cAbl7xJmC4v1PHJYqyRCtbr8e_at6w4fQ5cHyFfwyd9fMSdgA9cDEitgXhPcTr0WGBHkaoG2P7qJHdLO24WTuonb_2dLEMOTSAAnkYT32iaiid6i6PSWuF5L5Fsk4-nlLm7Rw30NhHfRsT5FxAdEnDbSlZWOIOlqrDT5o9Ke_W6I9OOEM1FkfaZPZDx4W9WrsTcuvfz8RRKKDke04x5Y1pBsTYbYYhiJxLdyLm5xiKwLOyP_YIWU7JofHCJFaEyAUsIeCl1OR1nmn8BnF-amLPvXefO95Vk_IgHrimxpQqr2D4Q5UdT78tGs4o1ewKKY4Rdn__x8_Tb95R-G57wkNqFWudSvbOCzOfRuk9o7aqjdKI3QQV2YZwB_3ylMKORtYFwqLOeQu6aBM
    indexer:
      type: local
      metricsDirectory: {{ .METRICS_FOLDER }}
    metrics: [metrics-profile.yaml]
{{ if .ALERTING }}
    alerts: [alerts.yml]
{{ end }}
{{ end }}

jobs:
  - name: {{ .JOB_NAME }}
    jobType: create
    jobIterations: {{ add .JOB_ITERATIONS 1 }}
    qps: {{ .QPS }}
    burst: {{ .BURST }}
    watchers:
    - kind: Deployment
      apiVersion: apps/v1
      labelSelector: {foo: bar}
    - kind: Pod
      apiVersion: v1
      labelSelector: {foo: bar}
      replicas: 2
    - kind: StorageClass
      apiVersion: storage.k8s.io/v1
      replicas: 1
    namespacedIterations: true
    preLoadImages: {{ .PRELOAD_IMAGES }}
    preLoadPeriod: 2s
    cleanup: true
    namespace: {{ .JOB_NAME }}
    podWait: false
    waitWhenFinished: true
    verifyObjects: true
    errorOnVerify: true
    jobIterationDelay: 1s
    maxWaitTimeout: 2m
{{ if .INCREMENTAL_LOAD }}
    incrementalLoad:
      startIterations: 5
      totalIterations: 20
      stepDelay: 2s
      pattern:
        type: linear
        linear:
          minSteps: 4
          stepSize: 5
{{ end }}
    churnConfig:
      cycles: {{ .CHURN_CYCLES }}
      percent: 50
      delay: 2s
      mode: {{ .CHURN_MODE }}
    gc: {{env "JOBGC" }}
    namespaceLabels:
      foo: bar
      complex.label/test: true
    objects:

    - objectTemplate: objectTemplates/deployment.yml
      replicas: 1
      inputVars:
        envName: deployment-pod
        containerImage: quay.io/cloud-bulldozer/sampleapp:latest
        envVar: 55d897a9c68ea8a48e59f5ec9cf40aa7ffbdfd33e40bf71ee0ffdba1611518586015791965693165b030b20af4d0979a83d098fcf289e9e9fcbb170df5b144314f3d8d5c0755e0415ed5f8ec53a20f0ac8344e719e0993b3ddecd1d6e7b5f9a4b4cf78c9b9a6f328d754d955d897a9c68ea8a48e59f5ec9cf40aa7ffbdfd33e40bf71ee0ffdba1611518586015791965693165b030b20af4d0979a83d098fcf289e9e9fcbb170df5b144314f3d8d5c0755e0415ed5f8ec53a20f0ac8344e719e0993b3ddecd1d6e7b5f9a4b4cf78c9b9a6f328d754d92857528fe63427c66d5427cc3b61a10a86d5970c4315ced8f0584e1aabc9a696b2414df6268413cb0cdf8828d4fdd2504121e66309b19544325466a8cb2c599307f4ff76eeb64254b81c3fe4969759ff8fd811851d2ff4784c4959eb9af44eda26feb7ede29029c675c317fcc68fc900b52ba28b6e7af3e1d5523e0070776e406371ff6ca1b2437f9e0629b691234edbbeffbabfc305
      {{- if env "WAIT_FOR_CONDITION" }}
      waitOptions:
        customStatusPaths:
        - key: '{{ env `WAIT_CUSTOM_STATUS_PATH` }}'
          value: '{{ env `WAIT_FOR_CONDITION` }}'
      {{- end }}

    - objectTemplate: objectTemplates/pod.yml

    - objectTemplate: objectTemplates/job.yml
      replicas: 1

    - objectTemplate: objectTemplates/service.yml
      replicas: 1
      churn: false

    - objectTemplate: objectTemplates/secret.yml
      replicas: 1
      runOnce: true

{{ if .CRD }}
  - name: crd
    jobType: create
    jobIterations: 1
    namespacedIterations: false
    cleanup: false
    podWait: false
    qps: 10
    burst: 10
    jobPause: 10s
    objects:
    - objectTemplate: objectTemplates/crd.yml
      replicas: 1

  - name: cr-crd
    namespace: cr-crd
    jobType: create
    jobIterations: 1
    namespacedIterations: false
    cleanup: false
    podWait: false
    qps: 10
    burst: 10
    objects:
    - objectTemplate: objectTemplates/cr.yml
      replicas: 5
{{ end }}