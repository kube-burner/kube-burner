# test-k8s.yml
on:
  workflow_call:
jobs:
  test-k8s:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        k8s-version:
        - v1.24.0
        - v1.23.0
        - v1.22.0
    steps:

    - name: Check out code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Download kube-burner binary
      uses: actions/download-artifact@v3
      with:
        name: kube-burner
        path: /tmp/

    - name: Execute tests
      working-directory: test
      run: |
        export PATH=${PATH}:/tmp/
        chmod +x /tmp/kube-burner
        ./run.sh
      env:
        KIND_VERSION: v0.16.0
        K8S_VERSION: ${{matrix.k8s-version}}

  ocp-wrapper:
    runs-on: ubuntu-latest
    concurrency:
      group: ocp-e2e-ci
    steps:

    - name: Check out code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Download kube-burner binary
      uses: actions/download-artifact@v3
      with:
        name: kube-burner
        path: /tmp/

    - name: Authenticate against OCP cluster
      run: oc login -u ${OPENSHIFT_USER} -p ${OPENSHIFT_PASSWORD} ${OPENSHIFT_SERVER} --insecure-skip-tls-verify=true
      env:
        OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
        OPENSHIFT_USER: ${{ secrets.OPENSHIFT_USER }}
        OPENSHIFT_PASSWORD: ${{ secrets.OPENSHIFT_PASSWORD }}

    - name: Execute tests
      working-directory: test
      run: |
        export PATH=${PATH}:/tmp/
        chmod +x /tmp/kube-burner
        ./run-ocp.sh
